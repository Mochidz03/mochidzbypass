(async function() {
    'use strict';

    // Cấu hình
    const yeumoneyDomain = 'yeumoney.com';
    const verificationDomains = {
        '188BET': {
            url: 'https://165.22.63.250/',
            waitTime: 55 * 1000, // 55 giây
            articleUrl: 'https://165.22.63.250/soi-keo-real-madrid-vs-rb-leipzig-07-03-2024/',
            codeWaitTime: 25 * 1000 // 25 giây
        },
        'M88': {
            url: 'https://bet88bi.com/',
            waitTime: 60 * 1000, // 60 giây
            articleUrl: 'https://bet88bi.com/chien-thuat-1-3-2-6-trong-baccarat/',
            codeWaitTime: 30 * 1000 // 30 giây
        },
        'W88': {
            url: 'https://188.166.185.213/',
            waitTime: 60 * 1000, // 60 giây
            articleUrl: 'https://188.166.185.213/top-game-slot-gpi-pho-bien/',
            codeWaitTime: 30 * 1000 // 30 giây
        }
    };
    const processingWaitTime = 75 * 1000; // 75 giây từ thông báo
    const randomDelay = () => Math.random() * 2000 + 500; // Độ trễ 500-2500ms

    // Kiểm tra trang Yeumoney
    function isYeumoneyPage() {
        return window.location.hostname.includes(yeumoneyDomain);
    }

    // Kiểm tra trang xác nhận
    function isVerificationPage() {
        return Object.values(verificationDomains).some(domain => window.location.href.includes(domain.url));
    }

    // Kiểm tra trang bài viết
    function isArticlePage() {
        return Object.values(verificationDomains).some(domain => window.location.href === domain.articleUrl);
    }

    // Chờ phần tử
    async function waitForElement(selector, timeout = 15000) {
        return new Promise((resolve, reject) => {
            const element = document.querySelector(selector);
            if (element) return resolve(element);

            const observer = new MutationObserver(() => {
                const target = document.querySelector(selector);
                if (target) {
                    observer.disconnect();
                    resolve(target);
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });

            setTimeout(() => {
                observer.disconnect();
                reject(new Error(`Không tìm thấy ${selector} trong ${timeout}ms`));
            }, timeout);
        });
    }

    // Mô phỏng nhập liệu
    function simulateInput(element, value) {
        element.value = value;
        element.dispatchEvent(new Event('input', { bubbles: true }));
        element.dispatchEvent(new Event('change', { bubbles: true }));
    }

    // Mô phỏng click
    function simulateClick(element) {
        element.dispatchEvent(new MouseEvent('click', { bubbles: true }));
    }

    // Lấy mã từ trang bài viết
    async function getCodeFromArticlePage() {
        try {
            // Tìm và nhấn "Lấy mã"
            const getCodeButton = await waitForElement('a:contains("Lấy mã"), #get-code-btn', 10000);
            simulateClick(getCodeButton);

            // Xác định thời gian chờ dựa trên trang hiện tại
            const domain = Object.keys(verificationDomains).find(key => window.location.href.includes(verificationDomains[key].articleUrl));
            const codeWaitTime = verificationDomains[domain].codeWaitTime;

            // Chờ để lấy mã
            await new Promise(resolve => setTimeout(resolve, codeWaitTime + randomDelay()));
            const codeElement = await waitForElement('input[name="code"], #code, .code', 10000);
            const code = codeElement.value || codeElement.textContent.trim();
            if (code) {
                GM_setValue('verificationCode', code);
                window.close();
            } else {
                throw new Error('Không tìm thấy mã');
            }
        } catch (error) {
            console.error('Lỗi lấy mã:', error);
            window.close();
        }
    }

    // Xử lý trang xác nhận
    async function handleVerificationPage() {
        try {
            // Xác định trang hiện tại
            const domain = Object.keys(verificationDomains).find(key => window.location.href.includes(verificationDomains[key].url));
            const waitTime = verificationDomains[domain].waitTime;
            const articleUrl = verificationDomains[domain].articleUrl;

            // Chờ thời gian quy định
            await new Promise(resolve => setTimeout(resolve, waitTime + randomDelay()));

            // Tìm và nhấn vào bài viết
            const articleLink = await waitForElement(`a[href="${articleUrl}"]`, 10000);
            simulateClick(articleLink);
        } catch (error) {
            console.error('Lỗi xử lý trang xác nhận:', error);
            window.close();
        }
    }

    // Logic chính
    async function bypassYeumoney() {
        if (isArticlePage()) {
            await getCodeFromArticlePage();
            return;
        }

        if (isVerificationPage()) {
            await handleVerificationPage();
            return;
        }

        if (!isYeumoneyPage()) return;

        try {
            // Bước 1: Nhấn "Lấy mã" trên Yeumoney
            const getCodeButton = await waitForElement('button:contains("Lấy mã"), #get-code-btn', 10000);
            simulateClick(getCodeButton);
            await new Promise(resolve => setTimeout(resolve, randomDelay()));

            // Bước 2: Chờ thông báo "Đang xử lý! Vui lòng đợi 75 giây..."
            const processingMessage = await waitForElement('div:contains("Đang xử lý! Vui lòng đợi 75 giây...")', 5000);
            if (processingMessage) {
                await new Promise(resolve => setTimeout(resolve, processingWaitTime + randomDelay()));
            }

            // Bước 3: Xác định nền tảng
            const platformElement = await waitForElement('span:contains("188BET"), span:contains("M88"), span:contains("W88")');
            const platform = platformElement.textContent.trim();
            const verifyUrl = verificationDomains[platform].url;
            if (!verifyUrl) throw new Error('Không tìm thấy URL xác nhận');

            // Bước 4: Mở tab mới để truy cập trang xác nhận
            window.open(verifyUrl, '_blank');
            await new Promise(resolve => setTimeout(resolve, 5000));

            // Bước 5: Chờ và lấy mã
            let attempts = 0;
            let code = GM_getValue('verificationCode', '');
            while (!code && attempts < 5) {
                await new Promise(resolve => setTimeout(resolve, 10000));
                code = GM_getValue('verificationCode', '');
                attempts++;
            }
            if (!code) throw new Error('Không lấy được mã');

            // Bước 6: Nhập mã vào ô "Nhập mã ngày"
            const codeInput = await waitForElement('input[name="code"], #code-input, input[type="text"]', 10000);
            simulateInput(codeInput, code);
            await new Promise(resolve => setTimeout(resolve, randomDelay()));

            // Bước 7: Nhấn "Xác nhận"
            const confirmButton = await waitForElement('button:contains("Xác nhận"), #confirm-btn', 5000);
            simulateClick(confirmButton);
            await new Promise(resolve => setTimeout(resolve, randomDelay()));

            // Bước 8: Chuyển đến trang đích
            const finalLink = await waitForElement('a[href*="final"], a:not([href*="javascript"])', 10000);
            window.location.href = finalLink.href;
        } catch (error) {
            console.error('Lỗi vượt link:', error);
        }
    }

    // Chạy script
    if (document.readyState === 'complete') {
        bypassYeumoney();
    } else {
        window.addEventListener('load', bypassYeumoney);
    }
})();
